name: 听书神器-固定包名共存版
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-coexist-shipook:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jdk apktool zipalign keytool

      - name: Set config
        run: |
          echo "ORIGIN_PACKAGE=com.xxx.audiobook" >> $GITHUB_ENV
          echo "TARGET_PACKAGE=com.shipook.reader.mfxsdq" >> $GITHUB_ENV
          echo "APK_INPUT=app/release/audiobook.apk" >> $GITHUB_ENV
          echo "TEMP_DIR=temp" >> $GITHUB_ENV
          echo "OUTPUT_DIR=output" >> $GITHUB_ENV

      - name: Create dirs
        run: mkdir -p ${{ env.TEMP_DIR }} ${{ env.OUTPUT_DIR }}

      - name: Decompile APK
        run: apktool d ${{ env.APK_INPUT }} -o ${{ env.TEMP_DIR }}

      - name: Replace package name
        run: |
          # Replace package text
          find ${{ env.TEMP_DIR }} -type f \( -name "*.smali" -o -name "*.xml" -o -name "AndroidManifest.xml" \) | xargs sed -i "s/${{ env.ORIGIN_PACKAGE }}/${{ env.TARGET_PACKAGE }}/g"
          # Replace smali path format
          find ${{ env.TEMP_DIR }}/smali -name "*.smali" | xargs sed -i "s/L${{ env.ORIGIN_PACKAGE//./\/ }}/L${{ env.TARGET_PACKAGE//./\/ }}/g"
          # Move smali dir
          ORIGIN_PATH=$(echo ${{ env.ORIGIN_PACKAGE }} | tr '.' '/')
          TARGET_PATH=$(echo ${{ env.TARGET_PACKAGE }} | tr '.' '/')
          mv ${{ env.TEMP_DIR }}/smali/$ORIGIN_PATH ${{ env.TEMP_DIR }}/smali/$TARGET_PATH
          # Fix permission
          chmod -R 755 ${{ env.TEMP_DIR }}/smali

      - name: Rebuild APK
        run: apktool b ${{ env.TEMP_DIR }} -o ${{ env.OUTPUT_DIR }}/unsigned.apk

      - name: Sign APK
        run: |
          keytool -genkeypair -keystore ${{ env.OUTPUT_DIR }}/sign.keystore -alias shipook -keyalg RSA -keysize 2048 -validity 3650 -storepass 123456 -keypass 123456 -dname "CN=Shipook"
          jarsigner -sigalg SHA256withRSA -digestalg SHA-256 -keystore ${{ env.OUTPUT_DIR }}/sign.keystore -storepass 123456 -keypass 123456 ${{ env.OUTPUT_DIR }}/unsigned.apk shipook
          zipalign -f 4 ${{ env.OUTPUT_DIR }}/unsigned.apk ${{ env.OUTPUT_DIR }}/shipook_signed.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: shipook-reader-coexist-apk
          path: ${{ env.OUTPUT_DIR }}/shipook_signed.apk
          retention-days: 90
