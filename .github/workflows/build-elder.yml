name: 直接改APK包名（无代码修改）
on: workflow_dispatch
jobs:
  build-and-rename-apk:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4
        with:
          repository: 692873036/HMA-OSS
          ref: master

      - name: 配置JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: 生成local.properties
        run: echo "sdk.dir=/usr/local/lib/android/sdk" > local.properties

      - name: 构建原始APK
        run: |
          chmod +x ./gradlew
          ./gradlew assembleRelease --no-daemon

      - name: 安装apktool（用于改包名）
        run: sudo apt-get install -y apktool

      - name: 解包APK并改包名
        run: |
          # 原始APK路径
          APK_PATH="app/build/outputs/apk/release/app-release.apk"
          # 新包名
          NEW_PACKAGE="com.shipook.reader.mfxsdq"
          # 解包
          apktool d "$APK_PATH" -o temp_apk
          # 修改AndroidManifest.xml的包名
          sed -i "s/package=\".*\"/package=\"$NEW_PACKAGE\"/g" temp_apk/AndroidManifest.xml
          # 修改应用名称
          sed -i 's/HMA-OSS/听书神器/g' temp_apk/res/values/strings.xml
          # 重打包
          apktool b temp_apk -o modified_app.apk

      - name: 签名APK（必须签名才能安装）
        run: |
          # 生成签名密钥
          keytool -genkey -v -keystore my-release-key.keystore -alias alias_name -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Android Debug,O=Android,C=US"
          # 签名APK
          jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore my-release-key.keystore modified_app.apk alias_name -storepass android -keypass android

      - name: 上传改包名后的APK
        uses: actions/upload-artifact@v4
        with:
          name: 改包名成功APK
          path: modified_app.apk
