name: 自动改包名（最终稳定版）
on:
  push:
    branches: [master]  # master分支推送时自动执行

jobs:
  modify_apk:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：安装工具（仅保留必要组件）
      - name: 安装依赖工具
        run: |
          sudo apt-get update
          sudo apt-get install -y apktool zipalign wget

      # 步骤2：配置JDK（提供keytool）
      - name: 配置Java环境
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 步骤3：下载目标APK
      - name: 下载待修改APK
        run: |
          wget "https://release-assets.githubusercontent.com/github-production-release-asset/1051338971/3d9bff3d-2ee1-4bc1-8e53-b8f79855cd41?sp=r&sv=2018-11-09&sr=b&spr=https&se=2025-11-28T17%3A45%3A49Z&rscd=attachment%3B+filename%3DHMA-OSS-oss-130-release.apk&rsct=application%2Fvnd.android.package-archive&skoid=96c2d410-5711-43a1-aedd-ab1947aa7ab0&sktid=398a6654-997b-47e9-b12b-9515b896b4de&skt=2025-11-28T16%3A45%3A30Z&ske=2025-11-28T17%3A45%3A49Z&sks=b&skv=2018-11-09&sig=MdBGmtn4y%2BX0r3DTbgqfYIh0HWhBBG7W6APrteojYkY%3D&jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicicmVsZWFzZS1hc3NldHMuZ2l0aHVidXNlcmNvbnRlbnQuY29tIiwia2V5Ijoia2V5MSIsImV4cCI6MTc2NDM0OTIzOCwibmJmIjoxNzY0MzQ4OTM4LCJwYXRoIjoicmVsZWFzZWFzc2V0cHJvZHVjdGlvbi5ibG9iLmNvcmUud2luZG93cy5uZXQifQ.0ccIbA7YP20wrgOCjouwSEFloKn2y2UrtYvfxpZJGwE&response-content-disposition=attachment%3B%20filename%3DHMA-OSS-oss-130-release.apk&response-content-type=application%2Fvnd.android.package-archive" -O target.apk

      # 步骤4：解包APK
      - name: 解包APK
        run: apktool d target.apk -o temp_apk

      # 步骤5：修改包名
      - name: 替换包名
        run: |
          find temp_apk -name "*.xml" -o -name "*.smali" | xargs sed -i "s/org.frknkrc44.hma_oss/com.shipook.reader.mfxsdq/g"

      # 步骤6：重打包APK
      - name: 重打包APK
        run: apktool b temp_apk -o modified_unsigned.apk

      # 步骤7：签名并对齐APK
      - name: 签名APK
        run: |
          # 使用JDK内置keytool生成密钥
          keytool -genkey -v -keystore sign.keystore -alias sign_alias -storepass 123456 -keypass 123456 -dname "CN=Sign, OU=Sign, O=Sign, L=Sign, S=Sign, C=CN"
          # 签名APK
          jarsigner -sigalg SHA256withRSA -digestalg SHA-256 -keystore sign.keystore modified_unsigned.apk sign_alias -storepass 123456
          # 对齐APK
          zipalign -f 4 modified_unsigned.apk final.apk

      # 步骤8：上传结果
      - name: 上传改包名后的APK
        uses: actions/upload-artifact@v4
        with:
          name: 改包名完成APK
          path: final.apk
