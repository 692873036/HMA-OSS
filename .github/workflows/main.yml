name: 基于仓库APK改包名（无额外下载）
on: [push, workflow_dispatch]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码仓库（获取已有APK）
        uses: actions/checkout@v4

      - name: 定义路径（请替换为你仓库中APK的实际路径）
        run: |
          echo "APK_PATH=app/release/audiobook.apk" >> $GITHUB_ENV  # 替换为你仓库里的APK路径
          echo "TEMP_DIR=temp" >> $GITHUB_ENV

      - name: 解压APK提取Manifest
        run: |
          mkdir ${{ env.TEMP_DIR }}
          unzip ${{ env.APK_PATH }} AndroidManifest.xml -d ${{ env.TEMP_DIR }}

      - name: 安装Manifest格式转换工具
        run: sudo apt-get update && sudo apt-get install -y axml2xml

      - name: 二进制Manifest转文本
        run: axml2xml ${{ env.TEMP_DIR }}/AndroidManifest.xml ${{ env.TEMP_DIR }}/AndroidManifest.txt

      - name: 修改包名（核心操作）
        run: |
          # 替换根包名（原包名请替换为你APK的实际包名）
          sed -i "s/package=\"com\.xxx\.audiobook\"/package=\"com\.shipook\.reader\.mfxsdq\"/g" ${{ env.TEMP_DIR }}/AndroidManifest.txt
          # 替换权限、组件中的包名前缀
          sed -i "s/com\.xxx\.audiobook\./com\.shipook\.reader\.mfxsdq\./g" ${{ env.TEMP_DIR }}/AndroidManifest.txt

      - name: 文本Manifest转回二进制
        run: xml2axml ${{ env.TEMP_DIR }}/AndroidManifest.txt ${{ env.TEMP_DIR }}/AndroidManifest.xml

      - name: 替换APK中的Manifest（生成未签名APK）
        run: |
          zip ${{ env.APK_PATH }} ${{ env.TEMP_DIR }}/AndroidManifest.xml
          mv ${{ env.APK_PATH }} final_unsigend.apk

      - name: 上传未签名APK
        uses: actions/upload-artifact@v4
        with:
          name: unsigend-renamed-apk
          path: final_unsigend.apk
          retention-days: 90
