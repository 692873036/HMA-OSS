name: APatch改包名自动流程（修复闪退+完整替换）
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 安装依赖工具
        run: sudo apt-get update && sudo apt-get install -y apktool zipalign wget dos2unix

      - name: 配置Java环境
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: 下载原始APK
        run: wget "https://github.com/frknkrc44/HMA-OSS/releases/download/oss-130/HMA-OSS-oss-130-release.apk" -O t.apk

      - name: 反编译（保留资源，避免闪退）
        run: apktool d t.apk -o temp  # 移除 --no-res！资源缺失是闪退核心原因

      - name: 批量替换包名（全场景覆盖，避免残留）
        run: |
          # 1. 替换Manifest和smali中的包名（含路径格式）
          find temp -type f \( -name "*.smali" -o -name "AndroidManifest.xml" -o -name "*.xml" -o -name "*.txt" \) | xargs sed -i "s/org\.frknkrc44\.hma_oss/com\.shipook\.reader\.mfxsdq/g"
          # 2. 替换smali中的类路径格式（L开头的格式）
          find temp -name "*.smali" | xargs sed -i "s/Lorg\/frknkrc44\/hma_oss/Lcom\/shipook\/reader\/mfxsdq/g"
          # 3. 替换资源文件中引用的包名（如strings.xml、布局文件等）
          find temp/res -name "*.xml" | xargs sed -i "s/org\.frknkrc44\.hma_oss/com\.shipook\.reader\.mfxsdq/g"
          # 4. 替换smali目录结构（关键！否则找不到类，必闪退）
          mv temp/smali/org/frknkrc44/hma_oss temp/smali/com/shipook/reader/mfxsdq
          # 5. 修复目录权限
          chmod -R 755 temp/smali/com

      - name: 重编译APK（保留资源）
        run: apktool b temp -o m.apk  # 移除 --no-res，使用完整资源编译

      - name: 生成签名密钥+签名APK
        run: |
          keytool -genkey -v -keystore k.keystore -alias a -storepass 123456 -keypass 123456 -dname "CN=A" -keyalg RSA -keysize 2048 -validity 3650
          jarsigner -sigalg SHA256withRSA -digestalg SHA-256 -keystore k.keystore -storepass 123456 -keypass 123456 m.apk a
          zipalign -f 4 m.apk f.apk

      - name: 上传成品APK（纯英文名称，避免报错）
        uses: actions/upload-artifact@v4
        with:
          name: patched-renamed-apk
          path: f.apk
