name: APatch改包名自动流程（最终修复版）
on: [push, workflow_dispatch]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 安装依赖工具
        run: sudo apt-get update && sudo apt-get install -y apktool zipalign wget openjdk-21-jdk

      - name: 配置Java环境
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: 下载原始APK
        run: wget --timeout=30 "https://github.com/frknkrc44/HMA-OSS/releases/download/oss-130/HMA-OSS-oss-130-release.apk" -O t.apk

      - name: 反编译APK
        run: apktool d t.apk -o temp

      - name: 批量替换包名
        run: |
          # 替换包名文本
          find temp -type f \( -name "*.smali" -o -name "*.xml" -o -name "AndroidManifest.xml" \) | xargs sed -i "s/org\.frknkrc44\.hma_oss/com\.shipook\.reader\.mfxsdq/g"
          # 替换smali类路径
          find temp/smali -name "*.smali" | xargs sed -i "s/Lorg\/frknkrc44\/hma_oss/Lcom\/shipook\/reader\/mfxsdq/g"
          # 调整smali目录结构
          ORIGIN_DIR="temp/smali/org/frknkrc44/hma_oss"
          TARGET_DIR="temp/smali/com/shipook/reader/mfxsdq"
          mkdir -p $(dirname $TARGET_DIR)
          mv $ORIGIN_DIR $TARGET_DIR
          # 修复目录权限
          chmod -R 755 temp/smali

      - name: 修复资源文件名（移除$符号）
        run: |
          # 重命名含$的资源文件（替换为下划线）
          find temp/res/drawable* -name "*\$*" | while read file; do
            new_file=$(echo "$file" | tr '$' '_')
            mv "$file" "$new_file"
          done
          # 同步修改xml中的资源引用
          find temp/res -name "*.xml" | xargs sed -i "s/\$/\_/g"

      - name: 重编译APK
        run: apktool b temp -o m.apk --use-aapt2

      - name: 签名APK
        run: |
          keytool -genkeypair -keystore k.keystore -alias a -storepass 123456 -keypass 123456 -dname "CN=A" -keyalg RSA -keysize 2048 -validity 3650
          jarsigner -keystore k.keystore -storepass 123456 -keypass 123456 -sigalg SHA256withRSA -digestalg SHA-256 m.apk a
          zipalign -f 4 m.apk f.apk

      - name: 上传成品APK
        uses: actions/upload-artifact@v4
        with:
          name: patched-renamed-apk
          path: f.apk
          retention-days: 90
